<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<html lang="en-US">
    <head>
        <title>Answers to Questions and Exercises: Concurrency (The Java&trade; Tutorials &gt; Essential Classes &gt;
            Concurrency)</title>
<style type="text/css">
    .FigureCaption   { 
        margin-left: 1in; 
        margin-right: 1in; 
        font-family: sans-serif; 
        font-size: smaller; 
        text-align: justify;
    }
    #TopBar_bl {
        background: url(../../../images/java_bar_bl.gif) 0 100% no-repeat;
        width: 100%;
        height: 60px;
    }
    #TopBar_br {
        background: url(../../../images/java_bar_br.gif) 100% 100% no-repeat;
        width: 100%;
        height: 60px;
    }
    #TopBar_tl {
        background: url(../../../images/java_bar_tl.gif) 0 0 no-repeat;
        width: 100%;
        height: 60px;
    }
    #TopBar_tr {
        background: url(../../../images/java_bar_tr.gif) 100% 0 no-repeat;
        width: 100%;
        height: 60px;
    }
    #TopBar {
        background: #35556B url(../../../images/java_bar.gif);
        margin: 10px 10px 0 10px;
        height:60px;
        min-width:700px;
        color: white;
        font-family: sans-serif; 
        font-weight: bold;
    }
    @media print {
        #BreadCrumbs, #Download {
            display: none;
        }
    }
    #TopBar_right {
        line-height: 14px;
        float: right;
        padding-top: 2px;
        padding-right: 30px;
        text-align: center;
    }
    @media print {
        #TopBar_right {
            display: none;
        }
    }
    #TopBar_right a {
        font-size: 12px;
        margin: 3px;
        padding: 0;
    }
    #TopBar a:visited, #TopBar a:link {
        color: white;
        text-decoration: none;
    }
    #TopBar a:hover, #TopBar a:active  {
        background-color: white;
        color: #35556B;
    }
    #BreadCrumbs {
        padding: 4px 5px 0.5em 0;
        font-family: sans-serif; 
        float: right;
    }
    #BreadCrumbs a {
        color: blue;
    }
    #BreadCrumbs a:visited, #BreadCrumbs a:link {
        text-decoration: none;
    }
    #BreadCrumbs a:hover, #BreadCrumbs a:active {
        text-decoration: underline;
    }
    #PageTitle {
        margin: 0 5px 0.5em 0;
        color: #F90000;
    }    
    #PageContent{
        margin: 0 5px 0 20px;
    }
    .LeftBar_shown {
        width: 13em;
        float: left;
        margin-left: 10px;
        margin-top: 4px;
        margin-bottom: 2em;
        margin-right: 10px;
    }
    @media print {
        .LeftBar_shown {
            display: none;
        }
    }
    .LeftBar_hidden {
        display: none;
    }
    #Footer {
        padding-top: 10px;
        padding-left: 10px;
        margin-right: 10px;
    }
    
    .footertext {
        font-size: 10px;
        font-family: sans-serif; 
        margin-top: 1px;
    }
    
    #Footer2 {
        padding-top: 10px;
        padding-left: 10px;
        margin-right: 10px;
    }
    .NavBit  {
        padding: 4px 5px 0.5em 0;
        font-family: sans-serif; 
    }
    @media print {
        .NavBit {
            display: none;
        }
    }
    #TagNotes {
        text-align: right;        
    }
    
    @media print {
        #TagNotes a:visited, #TagNotes a:link {
            color: #35556B;
            text-decoration: none;
        }
    }
    #Contents a, .NavBit a, #TagNotes a {
        color: blue
    }
    #TagNotes a:visited, #TagNotes a:link,
    #Contents a:visited, #Contents a:link,
    .NavBit a:visited, .NavBit a:link {
        text-decoration: none;
    }
    #TagNotes a:hover, #TagNotes a:active,   
    #Contents a:hover, #Contents a:active,   
    .NavBit a:hover, .NavBit a:active {  
        text-decoration: underline;
    }
    #Contents {
        float: left;
        font-family: sans-serif; 
    }
    @media print {
        #Contents {
            display: none;
        }
    }
    @media screen {
        div.PrintHeaders {
            display: none;
        }
    }
    .linkLESSON, .nolinkLESSON {
        margin-left: 0.5em;
        text-indent: -0.5em
    }
    .linkAHEAD, .nolinkAHEAD, .linkQUESTIONS, .nolinkQUESTIONS   {
        margin-left: 1.5em; 
        text-indent: -0.5em
    }
    .linkBHEAD, .nolinkBHEAD   {
        margin-left: 2.5em;
        text-indent: -0.5em
    }
    .linkCHEAD, .nolinkCHEAD   {
        margin-left: 3.5em;
        text-indent: -0.5em
    }
    .nolinkLESSON, .nolinkAHEAD, .nolinkBHEAD, .nolinkCHEAD,
    .nolinkQUESTIONS {
        font-weight: bold;
        color: #F90000;
    }
    .MainFlow_indented {
        margin-right: 10px;
        margin-left: 15em;
        margin-bottom: 2em;

    }
    .MainFlow_wide {
        margin-right: 10px;
        margin-left: 10px;
        margin-bottom: 2em;

    }
    @media print {
        .MainFlow_indented, .MainFlow_wide {
            padding-top: 0;
            margin-top: 10px;
            margin-right: 10px;
            margin-left: 0;
        }
    }
    h1, h2, h3, h4, h5 {
        color: #F90000;
        font-family: sans-serif;
    }

    h1 {
        font-weight: bold;
        font-size: 20px;
    }

    h2 {
        font-weight: bold;
        font-size: 17px;
    }

    h3 {
        font-weight: bold;
        font-size: 14px;
    }

    h4 {
        font-size: 15px;
    }

    h5 {
        font-size: 12px;
    }


    #ToggleLeft {
        display: none;
    }
    
    .note {
        margin: 0 30px 0px 30px;
    }
    
    .codeblock {
        margin: 0 30px 0px 30px;
    }

    /t

</style>
    </head>
<body>
    <div id=TopBar> <div id=TopBar_tr> <div id=TopBar_tl> <div id=TopBar_br> <div id=TopBar_bl> 
                        <div id=TopBar_right> 
                            <a target="_blank"
                                href="http://java.sun.com/javase/6/download.jsp">Download
                                the JDK</a>
                            <br>
                            <a href="../../../search.html" target="_blank">Search the
                                Tutorials</a>
                        </div>
                            <div class=PrintHeaders>
                                <b>Trail:</b> Essential Classes
                                <br><b>Lesson:</b> Concurrency
                            </div>
                    </div> </div> </div> </div> </div>

    <div class=MainFlow_wide>
        <span id=BreadCrumbs>
            <a href=../../../index.html target=_top>Home Page</a>
            &gt;
            <a href=../../index.html target=_top>Essential Classes</a>
            &gt;
            <a href=../index.html target=_top>Concurrency</a>
        </span>
        <div class=NavBit>
            <a href=../QandE/questions.html>&laquo; Previous</a>&nbsp;&bull;&nbsp;<a href=../../TOC.html>TOC</a>
        </div>
        <div id=PageTitle><h1>Answers to Questions and Exercises: Concurrency</h1></div>
        <div id=PageContent>


<h2>Questions</h2>



<ol>
<li> <b>Question:</b>
    Can you pass a <code>Thread</code> object to
    <code>Executor.execute</code>? Would such an invocation make
    sense? Why or why not?

<p>
     <b>Answer:</b>
     <code>Thread</code> implements the <code>Runnable</code>
     interface, so you can pass an instance of <code>Thread</code> to
     <code>Executor.execute</code>. However it doesn't make sense to
     use <code>Thread</code> objects this way. If the object is
     directly instantiated from <code>Thread</code>, its
     <code>run</code> method doesn't do anything. You can define a
     subclass of <code>Thread</code> with a useful <code>run</code>
     method &mdash; but such a class would implement features that the
     executor would not use. 

</li>
</ol>


<h2>Exercises</h2>

<ol>
<li> <b>Exercise:</b>
Compile and run
<a class="SourceLink" target="_blank" href="BadThreads.java"><code><code>BadThreads.java</code></code></a>:
<div class="codeblock"><pre>

public class BadThreads {

    static String message;

    private static class CorrectorThread extends Thread {

        public void run() {
            try {
                sleep(1000); 
            } catch (InterruptedException e) {}
            //Key statement 1:
            message = &quot;Mares do eat oats.&quot;; 
        }
    }

    public static void main(String args[]) throws InterruptedException {
        (new CorrectorThread()).start();
        message = &quot;Mares do not eat oats.&quot;;
        Thread.sleep(2000);
        //Key statement 2:
        System.out.println(message);
    }
}
</pre></div>
<p>The application should print out "Mares do eat oats." Is it
guaranteed to always do this? If not, why not? Would it help to change
the parameters of the two invocations of <code>Sleep</code>?
How would you guarantee that all changes to <code>message</code>
will be visible to the main thread?
<p>
     <b>Solution:</b>
     The program will almost always print out "Mares do eat oats."
     However, this result is not guaranteed, because there is no
     happens-before relationship between "Key statement 1" and "Key
     statment 2". This is true even if "Key statement 1" actually
     executes before "Key statement 2" &mdash; remember, a
     happens-before relationship is about visibility, not sequence.
     <p>
     There are two ways you can guarantee that all changes to
     <code>message</code> will be visible to the main thread:
     <ul>
         <li>In the main thread, retain a reference to the
         <code>CorrectorThread</code> instance. Then invoke
         <code>join</code> on that instance before referring to
         <code>message</code>
         <li>Encapsulate <code>message</code> in an object with
         synchronized methods. Never reference <code>message</code>
         except through those methods.
     </ul>
     <p>
     Both of these techniques establish the necessary happens-before
     relationship, making changes to <code>message</code> visible.
     <p>
     A third technique is to simply declare <code>message</code> as
     <code>volatile</code>. This guarantees that any write to
     <code>message</code> (as in "Key statement 1") will have a happens-before relationship with
     any subsequent reads of <code>message</code> (as in "Key
     statement 2"). But it does not guarantee that "Key statement 1"
     will <i>literally</i> happen before "Key statement 2". They will
     <i>probably</i> happen in sequence, but because of scheduling
     uncertainities and the unknown granularity of <code>sleep</code>,
     this is not guaranteed.
     <p>
     Changing the arguments of the two <code>sleep</code> invocations
     does not help either, since this does nothing to guarantee a
     happens-before relationship.

<p>
<li> <b>Exercise:</b>
Modify the producer-consumer example in <a
    href=../guardmeth.html>Guarded Blocks</a> to use a standard
library class instead of the <code>Drop</code> class.
<p>
<b>Solution:</b>
The
<a class="APILink" target="_blank" href="http://download.oracle.com/javase/7/docs/api/java/util/concurrent/BlockingQueue.html"><code>java.util.concurrent.BlockingQueue</code></a>
interface defines a <code>get</code> method that blocks if the queue
is empty, and a <code>put</code> methods that blocks if the queue is
full. These are effectively the same operations defined by
<code>Drop</code> &mdash; except that <code>Drop</code> is not a
queue! However, there's another way of looking at Drop: it's a queue
with a capacity of zero. Since there's no room in the queue for
<i>any</i> elements, every <code>get</code> blocks until the
corresponding <code>take</code> and every <code>take</code> blocks
until the corresponding <code>get</code>. There is an implementation
of <code>BlockingQueue</code> with precisely this behavior:
<a class="APILink" target="_blank" href="http://download.oracle.com/javase/7/docs/api/java/util/concurrent/SynchronousQueue.html"><code>java.util.concurrent.SynchronousQueue</code></a>.
<p>
<code>BlockingQueue</code> is almost a drop-in replacement for
<code>Drop</code>. The main problem in
<a class="SourceLink" target="_blank" href="Producer.java"><code><code>Producer</code></code></a>
is that with <code>BlockingQueue</code>, the <code>put</code> and
<code>get</code> methods throw <code>InterruptedException</code>. This
means that the existing <code>try</code> must be moved up a level:
<div class="codeblock"><pre>

import java.util.Random;
import java.util.concurrent.BlockingQueue;

public class Producer implements Runnable {
    private BlockingQueue&lt;String&gt; drop;

    public Producer(BlockingQueue&lt;String&gt; drop) {
        this.drop = drop;
    }

    public void run() {
        String importantInfo[] = {
            &quot;Mares eat oats&quot;,
            &quot;Does eat oats&quot;,
            &quot;Little lambs eat ivy&quot;,
            &quot;A kid will eat ivy too&quot;
        };
        Random random = new Random();

        try {
            for (int i = 0; i &lt; importantInfo.length; i++) {
                drop.put(importantInfo[i]);
                Thread.sleep(random.nextInt(5000));
            }
            drop.put(&quot;DONE&quot;);
        } catch (InterruptedException e) {}
    }
}

</pre></div>
Similar changes are required for
<a class="SourceLink" target="_blank" href="Consumer.java"><code><code>Consumer</code></code></a>:

<div class="codeblock"><pre>

import java.util.Random;
import java.util.concurrent.BlockingQueue;

public class Consumer implements Runnable {
    private BlockingQueue&lt;String&gt; drop;

    public Consumer(BlockingQueue&lt;String&gt; drop) {
        this.drop = drop;
    }

    public void run() {
        Random random = new Random();
        try {
            for (String message = drop.take(); ! message.equals(&quot;DONE&quot;);
                    message = drop.take()) {
                System.out.format(&quot;MESSAGE RECEIVED: %s%n&quot;, message);
                Thread.sleep(random.nextInt(5000));
            }
        } catch (InterruptedException e) {}
    }
}
                

</pre></div>
For
<a class="SourceLink" target="_blank" href="ProducerConsumerExample.java"><code><code>ProducerConsumerExample</code></code></a>,
we simply change the declaration for the <code>drop</code> object:
<div class="codeblock"><pre>

import java.util.concurrent.BlockingQueue;
import java.util.concurrent.SynchronousQueue;

public class ProducerConsumerExample {
    public static void main(String[] args) {
        BlockingQueue&lt;String&gt; drop = new SynchronousQueue&lt;String&gt; ();
        (new Thread(new Producer(drop))).start();
        (new Thread(new Consumer(drop))).start();
    }
}
</pre></div>

</ol>



        </div>
    </div>
    <div id=Footer2>
        <span class=NavBit>
            <a href=../QandE/questions.html>&laquo; Previous</a>
            &bull;
            <a href=../../TOC.html>TOC</a>
        </span>
<hr>
<div id=TagNotes>
    <p class="footertext">Problems with the examples? Try <a target="_blank"
        href=../../../information/run-examples.html>Compiling and Running
        the Examples: FAQs</a>.
    <br>
    Complaints? Compliments? Suggestions? <a target="_blank"
        href="http://download.oracle.com/javase/feedback.html">Give
    us your feedback</a>.
    </p>
</div> 

<div id=Footer>
<p class="footertext"><a name="license_info">Your use of this</a> page and all the material on pages under &quot;The Java Tutorials&quot; banner,
and all the material on pages under &quot;The Java Tutorials&quot; banner is subject to the <a href="../../../information/license.html">Java SE Tutorial Copyright
and License</a>.
Additionally, any example code contained in any of these Java
Tutorials pages is licensed under the
<a href="http://developers.sun.com/license/berkeley_license.html">Code
Sample License</a>.
</p>
<table border="0" cellspacing="0" cellpadding="5" summary="">
    <tr>
         <td headers="h1" width="20%">
	 <table width="100%" border="0" cellspacing="0" cellpadding="5">
            <tr>
              <td headers="h1" align="center"><img id=duke src=../../../images/DukeWave.gif width=55 height=55 alt="duke image"></td>
              <td headers="h2" align="left" valign="middle"><img id=oracle src=../../../images/logo_oracle_footer.gif width=100 height=29 alt="Oracle logo"></td>
           </tr>
          </table>
          </td>

          <td width="55%" valign="middle" align="center">
		<p class="footertext"><a href="http://www.oracle.com/us/corporate/index.html">About Oracle</a> | <a href="http://www.oracle.com/technology/index.html">Oracle Technology Network</a> | <a href="https://www.samplecode.oracle.com/servlets/CompulsoryClickThrough?type=TermsOfService">Terms of Service</a></p> 
	 </td>
          <td width="25%" valign="middle" align="right">
      		<p class="footertext">Copyright &copy; 1995, 2011 Oracle and/or its affiliates. All rights reserved.</p>
	 </td>
     </tr>     
</table>
</div>
    </div>
    <div class=PrintHeaders>
        <b>Previous page:</b> Questions and Exercises: Concurrency
    </div>

<!-- Start SiteCatalyst code   -->
<script language="JavaScript" src="http://www.oracle.com/ocom/groups/systemobject/@mktg_admin/documents/systemobject/s_code_download.js"></script>
<script language="JavaScript" src="http://www.oracle.com/ocom/groups/systemobject/@mktg_admin/documents/systemobject/s_code.js"></script>
<noscript> 
A browser with JavaScript enabled is required for this page to operate properly.
</noscript>
 
<!-- ********** DO NOT ALTER ANYTHING BELOW THIS LINE ! *********** -->
<!--  Below code will send the info to Omniture server -->
<script language="javascript">var s_code=s.t();if(s_code)document.write(s_code)</script>

 
<!-- End SiteCatalyst code -->

</body>
</html> 
