<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<html lang="en-US">
    <head>
        <title>Setting Privileges for Extensions (The Java&trade; Tutorials &gt;        
            The Extension Mechanism &gt; Making Extensions Secure)
</title>

     <meta name="description" content="This Java tutorial describes how to create and use extensions or optional packages and make them secure" />
     <meta name="keywords" content="java programming, learn java, java sample code, java extensions, java optional packages" />
        
<style type="text/css">
    .FigureCaption   { 
        margin-left: 1in; 
        margin-right: 1in; 
        font-family: sans-serif; 
        font-size: smaller; 
        text-align: justify;
    }
    #TopBar_bl {
        background: url(../../images/java_bar_bl.gif) 0 100% no-repeat;
        width: 100%;
        height: 60px;
    }
    #TopBar_br {
        background: url(../../images/java_bar_br.gif) 100% 100% no-repeat;
        width: 100%;
        height: 60px;
    }
    #TopBar_tl {
        background: url(../../images/java_bar_tl.gif) 0 0 no-repeat;
        width: 100%;
        height: 60px;
    }
    #TopBar_tr {
        background: url(../../images/java_bar_tr.gif) 100% 0 no-repeat;
        width: 100%;
        height: 60px;
    }
    #TopBar {
        background: #35556B url(../../images/java_bar.gif);
        margin: 10px 10px 0 10px;
        height:60px;
        min-width:700px;
        color: white;
        font-family: sans-serif; 
        font-weight: bold;
    }
    @media print {
        #BreadCrumbs, #Download {
            display: none;
        }
    }
    #TopBar_right {
        line-height: 14px;
        float: right;
        padding-top: 2px;
        padding-right: 30px;
        text-align: center;
    }
    @media print {
        #TopBar_right {
            display: none;
        }
    }
    #TopBar_right a {
        font-size: 12px;
        margin: 3px;
        padding: 0;
    }
    #TopBar a:visited, #TopBar a:link {
        color: white;
        text-decoration: none;
    }
    #TopBar a:hover, #TopBar a:active  {
        background-color: white;
        color: #35556B;
    }
    #BreadCrumbs {
        padding: 4px 5px 0.5em 0;
        font-family: sans-serif; 
        float: right;
    }
    #BreadCrumbs a {
        color: blue;
    }
    #BreadCrumbs a:visited, #BreadCrumbs a:link {
        text-decoration: none;
    }
    #BreadCrumbs a:hover, #BreadCrumbs a:active {
        text-decoration: underline;
    }
    #PageTitle {
        margin: 0 5px 0.5em 0;
        color: #F90000;
    }    
    #PageContent{
        margin: 0 5px 0 20px;
    }
    .LeftBar_shown {
        width: 13em;
        float: left;
        margin-left: 10px;
        margin-top: 4px;
        margin-bottom: 2em;
        margin-right: 10px;
    }
    @media print {
        .LeftBar_shown {
            display: none;
        }
    }
    .LeftBar_hidden {
        display: none;
    }
    #Footer {
        padding-top: 10px;
        padding-left: 10px;
        margin-right: 10px;
    }
    
    .footertext {
        font-size: 10px;
        font-family: sans-serif; 
        margin-top: 1px;
    }
    
    #Footer2 {
        padding-top: 10px;
        padding-left: 10px;
        margin-right: 10px;
    }
    .NavBit  {
        padding: 4px 5px 0.5em 0;
        font-family: sans-serif; 
    }
    @media print {
        .NavBit {
            display: none;
        }
    }
    #TagNotes {
        text-align: right;        
    }
    
    @media print {
        #TagNotes a:visited, #TagNotes a:link {
            color: #35556B;
            text-decoration: none;
        }
    }
    #Contents a, .NavBit a, #TagNotes a {
        color: blue
    }
    #TagNotes a:visited, #TagNotes a:link,
    #Contents a:visited, #Contents a:link,
    .NavBit a:visited, .NavBit a:link {
        text-decoration: none;
    }
    #TagNotes a:hover, #TagNotes a:active,   
    #Contents a:hover, #Contents a:active,   
    .NavBit a:hover, .NavBit a:active {  
        text-decoration: underline;
    }
    #Contents {
        float: left;
        font-family: sans-serif; 
    }
    @media print {
        #Contents {
            display: none;
        }
    }
    @media screen {
        div.PrintHeaders {
            display: none;
        }
    }
    .linkLESSON, .nolinkLESSON {
        margin-left: 0.5em;
        text-indent: -0.5em
    }
    .linkAHEAD, .nolinkAHEAD, .linkQUESTIONS, .nolinkQUESTIONS   {
        margin-left: 1.5em; 
        text-indent: -0.5em
    }
    .linkBHEAD, .nolinkBHEAD   {
        margin-left: 2.5em;
        text-indent: -0.5em
    }
    .linkCHEAD, .nolinkCHEAD   {
        margin-left: 3.5em;
        text-indent: -0.5em
    }
    .nolinkLESSON, .nolinkAHEAD, .nolinkBHEAD, .nolinkCHEAD,
    .nolinkQUESTIONS {
        font-weight: bold;
        color: #F90000;
    }
    .MainFlow_indented {
        margin-right: 10px;
        margin-left: 15em;
        margin-bottom: 2em;

    }
    .MainFlow_wide {
        margin-right: 10px;
        margin-left: 10px;
        margin-bottom: 2em;

    }
    @media print {
        .MainFlow_indented, .MainFlow_wide {
            padding-top: 0;
            margin-top: 10px;
            margin-right: 10px;
            margin-left: 0;
        }
    }
    h1, h2, h3, h4, h5 {
        color: #F90000;
        font-family: sans-serif;
    }

    h1 {
        font-weight: bold;
        font-size: 20px;
    }

    h2 {
        font-weight: bold;
        font-size: 17px;
    }

    h3 {
        font-weight: bold;
        font-size: 14px;
    }

    h4 {
        font-size: 15px;
    }

    h5 {
        font-size: 12px;
    }


    #ToggleLeft {
        display: none;
    }
    
    .note {
        margin: 0 30px 0px 30px;
    }
    
    .codeblock {
        margin: 0 30px 0px 30px;
    }

    /t

</style>
<script type="text/javascript">
    function leftBar() {
        var nameq = 'tutorial_showLeftBar='
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookieString = cookies[i];
            while (cookieString.charAt(0) == ' ') {
                cookieString = cookieString.substring(1, cookieString.length);
            }
            if (cookieString.indexOf(nameq) == 0) {
                cookieValue =  cookieString.substring(nameq.length,
                        cookieString.length);
                return cookieValue == 'yes';
            }
        }
        return true;
    }

    function showLeft(b) {
        var contents = document.getElementById("LeftBar");
        var main = document.getElementById("MainFlow");
        var toggle = document.getElementById("ToggleLeft");
        if (b) {
            contents.className = "LeftBar_shown";
            main.className = "MainFlow_indented";
            toggle.innerHTML = "Hide the TOC";
            document.cookie = 'tutorial_showLeftBar=yes; path=/';
        } else {
            contents.className = "LeftBar_hidden";
            main.className = "MainFlow_wide";
            toggle.innerHTML = "Show the TOC";
            document.cookie = 'tutorial_showLeftBar=no; path=/';
        }
    }

    function toggleLeft() {
        showLeft(document.getElementById("LeftBar").className ==
                "LeftBar_hidden");
        document.getElementById("ToggleLeft").blur();
    }

    function load() {
        showLeft(leftBar());
        document.getElementById("ToggleLeft").style.display="inline";
    }
    
</script>
<noscript> 
A browser with JavaScript enabled is required for this page to operate properly.
</noscript>

    </head>
<body onload="load()">
    <div id=TopBar> <div id=TopBar_tr> <div id=TopBar_tl> <div id=TopBar_br> <div id=TopBar_bl> 
                        <div id=TopBar_right> 
                            <a target="_blank"
                                href="http://java.sun.com/javase/6/download.jsp">Download
                                the JDK</a>
                            <br>
                            <a href="../../search.html" target="_blank">Search the
                                Tutorials</a>
                            <br>
                            <a href="javascript:toggleLeft()"
                                id="ToggleLeft">Hide the TOC</a>
                        </div>
                    </div> </div> </div> </div> </div>
    <div class=PrintHeaders>
        <b>Trail:</b> The Extension Mechanism
        <br><b>Lesson:</b> Making Extensions Secure
    </div>

    <div id=LeftBar class=LeftBar_shown>
        <div id=Contents>
            <div class="linkLESSON"><a href="index.html">Making Extensions Secure</a></div>
<div class="nolinkAHEAD">Setting Privileges for Extensions</div>
<div class="linkAHEAD"><a href="sealing.html">Sealing Packages in Extensions</a></div>
</div>
    </div>
    <div id=MainFlow class=MainFlow_indented>
            <span id=BreadCrumbs>
                <a href=../../index.html target=_top>Home Page</a>
                &gt;
                <a href=../index.html target=_top>The Extension Mechanism</a>
                &gt;
                <a href=index.html target=_top>Making Extensions Secure</a>
            </span>
            <div class=NavBit>
                <a target=_top href=index.html>&laquo;&nbsp;Previous</a>&nbsp;&bull;&nbsp;<a target=_top href=../TOC.html>Trail</a>&nbsp;&bull;&nbsp;<a target=_top href=sealing.html>Next&nbsp;&raquo;</a>
            </div>
            <div id=PageTitle><h1>Setting Privileges for Extensions</h1></div>
            <div id=PageContent>
If a
<a class="TutorialLink" target="_top" href="../../essential/environment/security.html">security manager</a> is in force, the following conditions must be met to 
enable any software, including extension software, to perform 
security-sensitive operations:
<ul>
<li>The security-sensitive code in the extension must be wrapped 
in a <code>PrivilegedAction</code> object.
<li>The security policy implemented by the security manager must 
grant the appropriate permission to the extension. By default, 
installed extensions are granted all security permissions as if 
they were part of the core platform API. The permissions 
granted by the security policy apply only to code wrapped in the 
<code>PrivilegedAction</code> instance.
</ul>
<p>
Let's look at each of these conditions in a little more detail, with 
some examples.
<p>
<h2>Using the PrivilegedAction Class</h2>
Suppose that you want to modify the <code>RectangleArea</code> class in the 
extension example of the previous 
lesson to write rectangle areas to a file rather than to 
stdout.  Writing to a file, however, is a security-sensitive 
operation, so if your software is going to be running under a 
security manager, you'll need to mark your code as being privileged. 
There are two steps you need to take to do so:
<ol>
<li>You need to place code that performs security-sensitive operations 
within the <code>run</code> method of an object of type 
<code>java.security.PrivilegedAction</code>.
<li>You must use that <code>PrivilegedAction</code> object as the 
argument in a call to the <code>doPrivileged</code> method of 
<code>java.security.AccessController</code>.
</ol>
<p>
If we apply those guidelines to the <code>RectangleArea</code> class, 
our class definition would look something like this:
<div class="codeblock"><pre>
import java.io.*;
import java.security.*;

public final class RectangleArea {
    public static void writeArea(final java.awt.Rectangle r) {
        AccessController.doPrivileged(new PrivilegedAction() {
	    public Object run() {
	        try { 
		    int area = r.width * r.height;
                    String userHome = System.getProperty("user.home");
		    FileWriter fw = new FileWriter(
                        userHome + File.separator
                        + "test" + File.separator
                        + "area.txt");
		    fw.write("The rectangle's area is " + area);
		    fw.flush();
		    fw.close();
	        } catch(IOException ioe) {
		    System.err.println(ioe);
	        }
	        return null;
	    }
        });
    }
}
</pre></div>
<p>
The single method in this class, <code>writeArea</code>, computes the 
area of a rectangle, and writes the area to a file called 
<code>area.txt</code> in the <code>test</code> directory under the user's home
directory.
<p>
The security-sensitive statements dealing with the output file are 
placed within the <code>run</code> method of a new instance of 
<code>PrivilegedAction</code>. (Note that <code>run</code> requires that an 
<code>Object</code> instance be returned. The returned object can be 
<code>null</code>.) The new <code>PrivilegedAction</code> 
instance is then passed as an argument in a call to 
<code>AccessController.doPrivileged</code>. 

<p>
For more information about using <code>doPrivileged</code>, see 

<a class="OutsideLink" target="_blank" href="http://download.oracle.com/javase/7/docs/technotes/guides/security/doprivileged.html">API for Privileged Blocks</a>  in the JDK&trade; documentation.

<p>
Wrapping security-sensitive code in a <code>PrivilegedAction</code> 
object in this 
manner is the first requirement for enabling an extension to perform 
security-sensitive operations. 
The second requirement is: getting the security manager 
to grant the privileged code the appropriate permissions.

<h2>Specifying Permissions with the Security Policy</h2>
The security policy in force at runtime is specified by a 
<em>policy file</em>.  The default  
policy is set by the file <code>lib/security/java.policy</code> in 
the JRE software.
<p>
The policy file assigns security privileges to software by using 
<em>grant</em> entries. The policy file can contain any number of 
grant entries. The default policy file has 
this grant entry for installed extensions:
<div class="codeblock"><pre>
grant codeBase "file:${{java.ext.dirs}}/*" {
    permission java.security.AllPermission;
};
</pre></div>
This entry specifies that files in the directories specified by
<code>file:${{java.ext.dirs}}/*</code> are to be granted the permission called 
<code>java.security.AllPermission</code>.

(Note that as of Java 6, <code>java.ext.dirs</code> refers to a
<tt>classpath</tt>-like path of directories, each of which can hold installed
extensions.)

It's not too hard to guess that <code>java.security.AllPermission</code> 
grants installed extensions all the security privileges that it's possible 
to grant. 
<p>
By default, then, installed extensions have no security restrictions.  
Extension software can perform security-sensitive operations as if there were 
no security manager installed, provided that security-sensitive code 
is contained in an instance of <code>PrivilegedAction</code> passed as an 
argument in a <code>doPrivileged</code> call. 
<p>
To limit the privileges granted to extensions, you need to 
modify the policy file. To deny all privileges to all extensions, 
you could simply remove the above grant entry.
<p>
Not all permissions are as comprehensive as the 
<code>java.security.AllPermission</code> granted by default. After 
deleting the default grant entry, you can enter a new grant entry 
for particular permissions, including:
<ul> 
<li><code>java.awt.<b>AWTPermission</b></code>
<li><code>java.io.<b>FilePermission</b></code>
<li><code>java.net.<b>NetPermission</b></code> 
<li><code>java.util.<b>PropertyPermission</b></code>
<li><code>java.lang.reflect.<b>ReflectPermission</b></code>
<li><code>java.lang.<b>RuntimePermission</b></code>
<li><code>java.security.<b>SecurityPermission</b></code>
<li><code>java.io.<b>SerializablePermission</b></code>
<li><code>java.net.<b>SocketPermission</b></code>
</ul>
<p>
The 
<a class="OutsideLink" target="_blank" href="http://download.oracle.com/javase/7/docs/technotes/guides/security/permissions.html">Permissions in the JDK</a> documentation provides details about each of these permissions.

Let's look at those needed to use RectangleArea as an extension.
<p>
The <code>RectangleArea.writeArea</code> method 
needs two permissions: one to determine the path to the user's home directory,
and the other to write to a file.

Assuming that the 
<code>RectangleArea</code> class is bundled in the file 
<code>area.jar</code>, you could grant write privileges by adding 
this entry to the policy file:
<div class="codeblock"><pre>
grant codeBase "file:${java.home}/lib/ext/area.jar" {
    permission java.io.PropertyPermission "user.home", "read";
    permission java.io.FilePermission "${user.home}${/}test${/}*", "write";
};
</pre></div>
The <code>codeBase&nbsp;"file:${java.home}/lib/ext/area.jar"</code> part 
of this 
entry guarantees that any permissions specified by this entry will 
apply only to the <code>area.jar</code>.

The <code>java.io.PropertyPermission</code> permits access to properties.

The first argument, <code>"user.home"</code>, names the property, and
the second argument, <code>"read"</code>, indicates that the property can be
read.

(The other choice is <code>"write"</code>.)

<p>

The <code>java.io.FilePermission</code> 
permits access to files.

The first argument, <code>"${user.home}${/}test${/}*"</code>, 
indicates that <code>area.jar</code> is being granted permission to 
access all files in the <code>test</code> directory that is in the user's home
directory.  (Note that <code>${/}</code> is a platform-independent file
separator.)

The second argument indicates that the file 
access being granted is only for writing.

(Other choices for the second argument are <code>"read"</code>,
<code>"delete"</code>, and <code>"execute"</code>.)
<h2>Signing Extensions</h2>
You can use the policy file to place additional restrictions on 
the permissions granted to extensions by requiring them to be signed 
by a trusted entity.
(For a review of signing and verifying JAR files, 
see the 
<a class="TutorialLink" target="_top" href="../../deployment/jar/signing.html">Signing JAR Files</a> lesson in this tutorial.)
<p>
To allow signature verification of extensions or other software in 
conjunction with granting permissions, the 
policy file must contain a <em>keystore entry</em>. The keystore entry 
specifies which keystore is to be used in the verification.  Keystore entries 
have the form
<div class="codeblock"><pre>
keystore "<i>keystore_url</i>";
</pre></div>
The URL <em>keystore_url</em> is either an absolute or relative. If it's 
relative, the URL is relative to the location of 
the policy file.
For example, to use the default keystore used by <tt>keytool</tt>, add this
entry to <tt>java.policy</tt>

<div class="codeblock"><pre>
keystore "file://${user.home}/.keystore";
</pre></div>

<p>
To indicate that an extension must be signed in order to be granted 
security privileges, you use the <code>signedBy</code> field. For example, 
the following entry indicates that the extension <code>area.jar</code> is 
to be granted the listed privileges only if it is signed by the users identified 
in the keystore by the aliases Robert and Rita:
<div class="codeblock"><pre>
grant signedBy "Robert,Rita",
    codeBase "file:${java.home}/lib/ext/area.jar" {
        permission java.io.PropertyPermission "user.home", "read";
        permission java.io.FilePermission "${user.home}${/}test${/}*", "write";
};
</pre></div>
If the <code>codeBase</code> field is omitted, as in the following "grant", 
the permissions are granted to <em>any</em> software, including 
installed or download extensions, that are signed by "Robert" or "Rita":
<div class="codeblock"><pre>
grant signedBy "Robert,Rita" {
    permission java.io.FilePermission "*", "write";  
};
</pre></div>

<p>
For further details about the policy file format, see section 3.3.1 of 
the 
<a class="OutsideLink" target="_blank" href="http://download.oracle.com/javase/7/docs/technotes/guides/security/spec/security-spec.doc3.html#20131">Security Architecture Specification</a>  in the JDK documentation.


        </div>
        <div class=NavBit>
            <a target=_top href=index.html>&laquo; Previous</a>
            &bull;
            <a target=_top href=../TOC.html>Trail</a>
            &bull;
            <a target=_top href=sealing.html>Next &raquo;</a>
        </div>
    </div>
    <div id=Footer2>
<hr>
<div id=TagNotes>
    <p class="footertext">Problems with the examples? Try <a target="_blank"
        href=../../information/run-examples.html>Compiling and Running
        the Examples: FAQs</a>.
    <br>
    Complaints? Compliments? Suggestions? <a target="_blank"
        href="http://download.oracle.com/javase/feedback.html">Give
    us your feedback</a>.
    </p>
</div> 

<div id=Footer>
<p class="footertext"><a name="license_info">Your use of this</a> page and all the material on pages under &quot;The Java Tutorials&quot; banner,
and all the material on pages under &quot;The Java Tutorials&quot; banner is subject to the <a href="../../information/license.html">Java SE Tutorial Copyright
and License</a>.
Additionally, any example code contained in any of these Java
Tutorials pages is licensed under the
<a href="http://developers.sun.com/license/berkeley_license.html">Code
Sample License</a>.
</p>
<table border="0" cellspacing="0" cellpadding="5" summary="">
    <tr>
         <td headers="h1" width="20%">
	 <table width="100%" border="0" cellspacing="0" cellpadding="5">
            <tr>
              <td headers="h1" align="center"><img id=duke src=../../images/DukeWave.gif width=55 height=55 alt="duke image"></td>
              <td headers="h2" align="left" valign="middle"><img id=oracle src=../../images/logo_oracle_footer.gif width=100 height=29 alt="Oracle logo"></td>
           </tr>
          </table>
          </td>

          <td width="55%" valign="middle" align="center">
		<p class="footertext"><a href="http://www.oracle.com/us/corporate/index.html">About Oracle</a> | <a href="http://www.oracle.com/technology/index.html">Oracle Technology Network</a> | <a href="https://www.samplecode.oracle.com/servlets/CompulsoryClickThrough?type=TermsOfService">Terms of Service</a></p> 
	 </td>
          <td width="25%" valign="middle" align="right">
      		<p class="footertext">Copyright &copy; 1995, 2011 Oracle and/or its affiliates. All rights reserved.</p>
	 </td>
     </tr>     
</table>
</div>
    </div>
    <div class=PrintHeaders>
        <b>Previous page:</b> Making Extensions Secure
        <br><b>Next page:</b> Sealing Packages in Extensions
    </div>

<!-- Start SiteCatalyst code   -->
<script language="JavaScript" src="http://www.oracle.com/ocom/groups/systemobject/@mktg_admin/documents/systemobject/s_code_download.js"></script>
<script language="JavaScript" src="http://www.oracle.com/ocom/groups/systemobject/@mktg_admin/documents/systemobject/s_code.js"></script>
<noscript> 
A browser with JavaScript enabled is required for this page to operate properly.
</noscript>
 
<!-- ********** DO NOT ALTER ANYTHING BELOW THIS LINE ! *********** -->
<!--  Below code will send the info to Omniture server -->
<script language="javascript">var s_code=s.t();if(s_code)document.write(s_code)</script>

 
<!-- End SiteCatalyst code -->

</body>
</html> 
